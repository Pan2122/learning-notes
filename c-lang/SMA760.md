---
layout: doc
title: SMA760 学习记录
description: SMA760 学习记录
tags: 
  - Bosch
  - SPI
  - 加速度传感器
---

# 📝SMA760/720 传感器与 SPI 协议全解

**学习背景**：学习底层寄存器操作，以博世 SMA760（汽车级加速度计）为例。
**目标角色**：Application Engineer (AE)
**文档版本**：Datasheet V5.0

---

## 🟢 第一部分：快速看懂这款芯片

拿到 Datasheet 别急着看时序图，先看“它是谁，干嘛的，有什么脾气”。

### 1. 核心定位

* **什么芯片？** MEMS 加速度计（针对汽车安全气囊系统 Airbag）。
* **关键特点**：
* **高量程**：X/Y 轴高达 **±128g**（普通手机只要 ±16g）。
* **高可靠**：设计符合 ISO26262 标准，通信带 CRC 校验。
* **双协议**：支持 **SafeSPI**（新一代标准）和 **Bosch SPI**（传统标准）。

### 2. 必须记住的“脾气” (Key Specs)

* **供电 (Power)**：
* **3.3V 模式** ( 供电)  消费级 MCU 常用。
* **6.7V 模式** ( 供电，内部稳压)  汽车 ECU 常用。
* **接口 (Interface)**：32-bit SPI，不支持 I2C。
* **封装**：SOIC8n (8脚芯片，比手机里的 LGA 封装好焊得多)。

### 3. 应用场景

* **Airbag ECU**：检测碰撞瞬间的剧烈减速。
* **主动悬架**：检测车身姿态（用到 Z 轴 ±32g）。

---

## 🔵 第二部分：物理层基础 (Hardware Layer)

在写代码前，必须确认示波器上看到的波形基础特征。

| 特性 | 参数 | AE 避坑备注 |
| --- | --- | --- |
| **CS (Chip Select)** | 低电平有效 () | 通信开始拉低，结束拉高。 |
| **最大速率** | 10 MHz | 调试时建议先降到 **2 MHz**，信号更稳。 |
| **数据长度** | **32 bits** | **不要发 8 位！** 必须一次发满 32 个时钟周期。 |
| **位序** | MSB First | 最高位先发。 |

---

## 🟠 第三部分：核心协议详解 (The Protocols)

这款芯片最特殊的地方在于它上电后是“懵”的，支持两种“方言”。你必须通过初始化命令告诉它用哪一种。

### 3.1 协议对比：SafeSPI vs. Bosch SPI

| 特性 | **SafeSPI (默认推荐)** | **Bosch SPI (传统模式)** |
| --- | --- | --- |
| **核心逻辑** | **Out of Frame (帧外)** | **In Frame (帧内)** |
| **问答机制** | 这一秒问，**下一秒**答。 | 这一秒问，**立刻**答。 |
| **SPI 模式** | **Mode 0** (CPOL=0, CPHA=0) | **Mode 1** (CPOL=0, CPHA=1) |
| **采样沿** | 上升沿采样 (Rising Sample) | 下降沿采样 (Falling Sample) |
| **CRC 初始值** | `0b101` | **`0b111`** (注意区别!) |
| **主要优势** | 更强的抗干扰能力，时序容错高。 | 简单直观，实时性略高。 |

> **⚠️ AE 警告**：
> 很多新手代码调不通，是因为**SPI Mode 配错了**！
> 
> * **SafeSPI** 用 Mode 0（空闲 SCK=0，第 1 个边沿采样）。
> * **Bosch SPI** 用 Mode 1（空闲 SCK=0，第 2 个边沿采样）。

---

### 3.2 SafeSPI 协议 (Out of Frame) 深度解析

**逻辑：** “延迟响应”。主机发送请求帧 Frame N，传感器在 Frame N+1 返回数据。

* **MOSI 帧结构 (MCU -> Sensor)**
* **Bit 31 (R/W)**: `0`=写, `1`=读。
* **Bit 30:24 (Addr)**: 7位寄存器地址。
* **Bit 23:8 (Data)**: 16位数据（读操作时填 0）。
* **Bit 7:5 (CRC)**: **3位 CRC** (基于 Seed `101`)。
* **MISO 帧结构 (Sensor -> MCU)**
* **Bit 31:18 (Data)**: 14位传感器数据。
* **Bit 17:16 (Status)**: `00`=正常, `01`=初始化, `11`=故障。
* **Bit 7:5 (CRC)**: 传感器返回的校验。

---

### 3.3 Bosch SPI 协议 (In Frame) 深度解析

**逻辑：** “即时响应”。利用全双工特性，主机发命令的同时，传感器就把上一次准备好的或者实时的数据推回来。

* **特殊功能：SPI Data Capturing**
* **痛点**：如果你分别读 X 轴和 Y 轴，两次读取中间有时间差，数据不同步。
* **解决**：Bosch SPI 支持“读 X 轴的同时，自动锁存 Y 轴数据”。
* **操作**：

1. 发读 Channel 1 命令  返回 Ch1 数据，同时芯片内部**冻结** Ch2 数据。
2. 发读 Channel 2 命令  返回刚才冻结的 Ch2 数据。

* *结果：获得了同一时刻的 X/Y 数据。*
* **帧结构差异**
* 虽然也是 32 位，但具体的 Status Bit 分布可能不同（需查阅 Datasheet Page 61 指令集）。
* CRC 计算多项式相同，但**初始值 (Seed) 是 `111**`。

---

## 🔴 第四部分：CRC 校验原理与实战

无论用哪种协议，CRC 都是必须跨过的坎。

### 4.1 数学原理

* **多项式**： 1+x+x^3 (二进制对应 `1011`)。
* **掩码 (Mask)**：`011` (代码运算用)。

### 4.2 移位寄存器算法 (Shift Register)

想象一个“传送带游戏”：

1. **准备**：寄存器装入初值（SafeSPI=`101`, Bosch SPI=`111`）。
2. **循环**：数据位逐个进入。

* 如果**移出的最高位是 1**  当前寄存器与掩码 **`011`** 进行异或 (XOR)。
* 如果**移出的最高位是 0**  仅移位，不异或。

### 4.3 C 语言实现逻辑 (以 SafeSPI 为例)

```c
// 伪代码
uint8_t crc = 0x05; // Seed 101 (如果是 Bosch SPI 改成 0x07)
uint8_t poly = 0x03; // Mask 011

for (each_bit_in_data_frame) {
    bool pop_bit = (crc >> 2) & 1; // 检查移出的最高位
    crc = (crc << 1) & 0x07;       // 左移，保持3位
    crc |= current_input_bit;      // 补入新数据
    
    if (pop_bit) {
        crc ^= poly; // 砸锤子 (XOR)
    }
}
```

---

## 🟣 第五部分：初始化流程 (Initialization Sequence)

SMA760 上电后不会自动输出数据，必须按顺序“解锁”。

1. **POR (Power On Reset)**：等待芯片启动（约 4ms）。
2. **Protocol Selection (关键！)**：

* 发送 Magic Code 选择协议。
* SafeSPI 发送：`0x00FF00FF`
* Bosch SPI 发送：`0xFF00FF00`
* *注意：这一步不带 CRC。*

3. **Voltage Mode Selection**：

* 告诉芯片你是 3.3V 还是 6.7V 供电。

4. **Configuration**：

* 设置量程、滤波参数。

5. **EOP (End of Programming)**：

* 发送锁定指令。
* 锁定后，芯片认为配置结束，开始输出有效数据。

---

## ⚫️ 第六部分：AE 调试避坑指南 (Troubleshooting)

1. **读不到 Device ID (0x00)？**

* 检查是否发送了 **Protocol Selection**？
* 如果是 SafeSPI，记得读数据要**读两次**（Out of Frame）。
* 检查 **Status 位**（Bit 17:16），如果是 `01`，说明还在初始化，加延时。

2. **CRC 报错 (CRC Error)？**

* 检查 **Initial Value**：SafeSPI 用 `5` (`101`)，Bosch SPI 用 `7` (`111`)。
* 检查计算范围：通常包含 Address 和 Data，但不包含 CRC 自己的位。

3. **数据乱跳？**

* 检查 SPI 模式：
* SafeSPI  CPOL=0, CPHA=0.
* Bosch SPI  CPOL=0, CPHA=1.
* 示波器检查 MOSI/MISO 在 CS 拉高期间是否由于高阻态（Hi-Z）产生了毛刺。

---

## 🏁 学习路线建议

1. **Level 1**: 用 BMI160 练习标准 SPI（8位，无 CRC），把波形看熟。
2. **Level 2**: 在 SMA760 上实现 **SafeSPI**，跑通初始化序列，读出 ID。
3. **Level 3**: 加入 CRC 校验函数，实现数据的可靠读取。
4. **Level 4**: 尝试切换到 **Bosch SPI**，体验 Mode 1 和数据捕获（Data Capturing）的区别。

```

